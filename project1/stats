#!/bin/sh

INPUT_FILE="stats_input$$"
TMP_FILE="stats_tmp$$"

function rows () {
    printf "Average\tMedian\n"
    while read line
    do
        # write row, newline separated, to temporary file
        printf "%s\n" $line > $TMP_FILE

        # sort temporary file
        sort $TMP_FILE -n -o $TMP_FILE

        # print average and median for row
        printf '%s\t%s\n' $(calculate_average) $(calculate_median)
    done < $INPUT_FILE
}

function columns () {
    local AVERAGES=()
    local MEDIANS=()

    local ROWS=$(wc -l < $INPUT_FILE)   # number of rows in file
    local WORDS=$(wc -w < $INPUT_FILE)  # number of numbers in file
    local COLS=$(( $WORDS / $ROWS ))    # calculate number of columns in file

    for COL in $(seq 1 $COLS)
    do
        $(> $TMP_FILE)
        while read LINE
        do
            # write column to temporary file
            echo $LINE | cut -d" " -f $COL >> $TMP_FILE
        done < $INPUT_FILE
        sort $TMP_FILE -n -o $TMP_FILE
        AVERAGES+=($(calculate_average))
        MEDIANS+=($(calculate_median))
    done

    echo Averages:
    printf "%s\t" "${AVERAGES[@]}"
    printf "\n"
    echo Medians:
    printf "%s\t" "${MEDIANS[@]}"
    printf "\n"
}

function calculate_average() {
    local SUM=0
    local COUNT=0
    local AVERAGE=0

    while read -r num
    do
        (( SUM += num ))
        (( COUNT += 1 ))
    done < $TMP_FILE
    AVERAGE=$( echo $SUM / $COUNT + 0.5 | bc -l )
    echo ${AVERAGE%.*}
}

function calculate_median() {
    local NUMS=$(wc -l < $TMP_FILE)
    local MEDIAN_INDEX=$(( ($NUMS / 2) +1 ))
    echo $( head -$MEDIAN_INDEX $TMP_FILE | tail -1 )
}

function clean_up() {
    rm -f $TMP_FILE
    rm -rf "stats_input$$"
}

trap clean_up EXIT

if [ "$#" = "1" ]
then
    cat > $INPUT_FILE
elif [ "$#" = "2" ]
then
    INPUT_FILE=$2
fi

if [ ! -r $INPUT_FILE ]
then
    >&2 echo "${0}: Cannot read ${INPUT_FILE}"
    clean_up
    exit 1
fi

if [ ! -s $INPUT_FILE ]
then
    >&2 echo "Usage: stats {-rows|-cols} [file]" 2>&1
    clean_up
    exit 1
fi

if [[ $1 == -r* ]];
then
    # separate files into rows **NEEDS ERROR HANDLING**
    rows
elif [[ $1 == -c* ]];
then
    # separate files into cols ** NEEDS ERROR HANDLING**
    columns
else
    >&2 echo "Usage: stats {-rows|-cols} [file]"
    clean_up
    exit 1
fi

# clean up files
clean_up

# HANDLE ERRORS
# NEED COMMENTS
# PIPE ERROR OUTPUT CORRECTLY
# CORRECT EXIT STATEMENTS

exit 0
